## Amazon EC2 (Elastic Compute Cloud)

### 1. 소개

- AWS의 컴퓨팅을 빌려 쓰는 서비스
- AWS에서 가장 중요한 서비스 중 하나

### 2. 구조

- Instance
  - EC2 에서 컴퓨팅을 담당
  - 저장을 담당하는 EBS(Elastic Block Store)와 네트워크로 연결
  - 하나의 가용 영역에만 존재
  - 저장 방식 (둘 중 하나만 선택하여 사용)
    - EBS(Elastic Block Store)
    - Instance store
      ```mermaid
      flowchart TD
      
      subgraph EBS[EBS 방식]
          EC2_1[Instance] --> |"네트워크 연결"| EV
          EV[("EBS 볼륨")]
      end
    
      subgraph IS[Instance store 방식]
          subgraph EC2[Instance]
              ISV[("인스턴스 스토리지 볼륨")]
          end
      end
      ```
  - Instance type (인스턴스 유형)
    - 인스턴스의 역할에 따라 CPU, 메모리, 스토리지, 네트워크 등을 조합한 구성
    - 사용 목적에 따라 최적화
    - 유형 별 명칭 존재 (t유형, m유형, inf유형 등)
      ![instance_type_naming_convention](/images/instance-type-naming-convention.png)
      ```text
      c7gn.2xlarge: 인스턴스 유형
      c7gn: 인스턴스 패밀리
      c: c 인스턴스 타입
      7: 7번째 세대
      g: AWS Graviton 프로세서 사용
      n: 네트워크 최적화
      2xlarge: 인스턴스 크기
      ```
      <a href="https://aws.amazon.com/ko/ec2/instance-types/">인스턴스 유형 DOCUMENT</a>

  - Instance 크기
    - 동일한 인스턴스 유형 내에서 여러 크기가 존재
    - CPU 개수, 메모리 크기, 성능 등으로 결정

- EBS (Elastic Block Store)
  - 네트워크로 연결된 가상의 하드 드라이브
  - EC2 인스턴스가 종료, 삭제돼도 유지 가능
  - Loose coupling 으로, 인스턴스 유형 변경이나 드라이브 추가에 용이함
  - 반드시 EC2 인스턴스와 같은 하나의 가용 영역에 존재해야 함
  - 종류
    ```text
    GP (General Purpose): 범용, SSD
    IOPS (Provisioned IOPS or IO): 프로비저닝 된 IOPS, SSD
    Throughput Optimized HDD or ST: 쓰루풋 최적화 (대용량 데이터 전송), HDD
    SC (Cold HDD): HDD
    Standard: HDD
    ```
  - Snapshot
    - EBS 의 특정 시점 전체를 저장한 이미지, 자동화 가능
    - 증분식으로, 바뀐 부분의 볼륨만 저장
    - S3 에 저장됨

- AMI (Amazon Machine Image)
  - EC2 인스턴스 실행을 위한 정보를 모아둔 템플릿
  - 구성
    ```text
    1개 이상의 EBS 스냅샷
    사용 권한
    블록 디바이스 매핑 (EC2 인스턴스를 위한 볼륨 정보)
    ```
  - 생성 방법
    - EBS 기반: 스냅샷을 사용하여 생성
    - 인스턴스 저장 기반: S3에 저장된 템플릿을 사용하여 생성

- Security Group (보안 그룹)
  - EC2 의 방화벽 역할
  - Whitelist 구조, 명시적으로 포트 활성화 필요

### 3. T type instance (Bustable performance instance)

- 저렴한 범용 인스턴스 유형
- 트래픽이 특정 시간에 몰리는 경우 사용하기 적합 (웹 서버, DB 등)


- CPU 크레딧 제도
  - 베이스 라인: CPU 사용량 기준 크레딧의 소모, 증감이 동일한 지점
  - Launch credit: T2 인스턴스의 경우 생성 직후 부하를 대비하여 기본 크레딧 제공
  - 크레딧이 없을 경우 베이스 라인으로 CPU 사용량이 동결됨
  - 최대 저장 가능 크레딧: 일반적으로 시간당 얻을 수 있는 크레딧 * 24 (하루)
  - 증가/감소 기준
    - 증가: CPU 사용량이 기본 수준 이상
    - 감소: CPU 사용량이 기본 수준 이하
    - 유지: CPU 사용량이 베이스 라인과 동일

- CPU 크레딧 계산
  - vCPU 가 사용하는 시간 단위
  - vCPU 1개가 1분 동안 100% 사용되면 1 크레딧을 소모
  - 베이스 라인 이하라면 (vCPU 숫자 * 베이스라인 * 60분) 만큼 크레딧 증가
    ```text
    - 크레딧 감소
    1 CPU credit = 1 vCPU * 100% utilization * 1min
                 = 1 vCPU * 50% utilization * 2min
                 = 2 vCPU * 50% utilization * 1min
    
    - 크레딧 증가
    6 CPU credit = 2 vCPU * 5%(1/20) baseline * 60min
                 = 1 vCPU * 10%(1/10) baseline * 60min
    ```
  - <a href="https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/burstable-credits-baseline-concepts.html">성능 버스트 가능
  인스턴스 DOCUMENT</a>
    ```mermaid
    xychart-beta
    x-axis "시간" [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
    y-axis "CPU 사용량(%)" 0 --> 100
    
    line [10, 10, 20, 30, 30, 30, 10, 10, 10, 10, 10, 10, 10, 80, 80,80, 80, 80, 20, 20, 20, 10, 5, 5]
    line [20, 20, 20, 20, 20,20, 20, 20, 20, 20,20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20]
    ```
    <table>
      <tr>&nbsp;&nbsp;&nbsp;🟦 CPU 사용량&nbsp;&nbsp;&nbsp;</tr>
      <tr>&nbsp;&nbsp;&nbsp;🟩 베이스 라인&nbsp;&nbsp;&nbsp;</tr>
    </table>

  - 0-1, 6-12, 21-23: CPU 사용량이 베이스 라인 아래, 크레딧 증가
  - 3-5, 13-17: CPU 사용량이 베이스 라인 위, 크레딧 차감
  - 18-20: CPU 사용량이 베이스 라인과 동일, 크레딧 변동 없음


- T instance mode
  - Standard mode (T2 default option)
    - 저장된 크레딧을 소모하여 CPU 사용
    - 크레딧이 없으면 베이스 라인으로 CPU 사용량 고정

  - Unlimited mode (T3 default option)
    - 저장된 크레딧을 소모하여 CPU 사용하고, 전부 소모하여도 제한 없이 CPU 사용
    - 크레딧이 없으면 24시간 이내 베이스 라인 이하로 유지하여 크레딧 반환
    - 반환하지 못한 크레딧은 비용 지불