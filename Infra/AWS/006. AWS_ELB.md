## ELB (Elastic Load Balancer)

### 1. 소개

- EC2 인스턴스, 컨테이너, IP 주소 등의 트래픽을 자동 분산
- EC2 인스턴스에 직접 트래픽을 발생시켜 헬스 체크
- 2개 이상의 가용 영역에서 동작
- IP 주소가 지속적으로 바뀌므로 도메인 기반으로 사용 필요
  ```mermaid
  flowchart TD
  
  USER[사용자] --> |"example.com<br>단일 도메인 접근"| ELB
  
  subgraph EBS[Availability zone]
      ELB[Elastic load balancer]
      AS["Auto scaling"]
      EC2_1["Instance(Running)<br>(111.111.111.1)"]
      EC2_2["Instance(Running)<br>(111.111.111.2)"]
      EC2_3["Instance(Running)<br>(111.111.111.3)"]
      EC2_4["Instance(Stopped)<br>(111.111.111.4)"]
      EC2_5["Instance(Pending)<br>(111.111.111.5)"]
  
      ELB --> EC2_1
      ELB --> EC2_2
      ELB --> EC2_3
      ELB --> |"중지된 인스턴스의<br>트래픽 차단"|EC2_4
      AS --> |"신규 인스턴스 생성"|EC2_5
      AS --> |"중지된 인스턴스 삭제"|EC2_4
  end
  ```
- 종류
  - Application load balancer
    - OSI 7 계층 전체에서 동작
    - 트래픽 모니터링 후 대상 인스턴스로 라우팅
  - Network load balancer
    - OSI 4 계층 (Transport)에서 동작
    - TCP, UDP 기반 빠른 트래픽 분산
    - 특수한 경우 다른 로드 밸런서 앞에서 동작하여 IP 고정 가능
      ```mermaid
      flowchart TD
        
      USER[사용자] --> |"111.111.111.1<br>고정 IP 접근"| ELB
        
      subgraph EBS[Availability zone]
          ELB["Network load balancer<br>(111.111.111.1)"]
          ALB["Application load balancer<br>(example.com)"]
          EC2_1["Instance"]
          EC2_2["Instance"]
          EC2_3["Instance"]
        
          ELB --> |example.com 접근|ALB
          ALB --> EC2_1
          ALB --> EC2_2
          ALB --> EC2_3
      end
      ```
  - Gateway load balancer
    - OSI 3 계층 (Network)에서 동작
    - 트래픽 검증 (보안)
    - 가상 어플라이언스 배포/확장 관리
  - Classic load balancer
    - 레거시 타입, 현재는 잘 사용되지 않음

### 2. Target Group (대상 그룹)

- ELB가 라우팅 할 대상의 그룹
- 대상이 될 수 있는 종류
  - 인스턴스
  - IP 주소
  - Lambda
  - ALB (NLB -> ALBs)
- 프로토콜 정의 가능 (HTTP, HTTPS, gRPC, TCP 등)
- 트래픽 분산 알고리즘 설정
- 대상 세션 고정 가능 (동일한 대상으로 트래픽 전송)
  ```mermaid
  flowchart TD
  
  USER[사용자] --> ELB
  
  subgraph EBS[Availability zone]
      ELB[Application load balancer]
  
      ELB --> |web.example.com|WS
      ELB --> |image.example.com|IS
      ELB --> |lambda.example.com:1234|LS
  
      subgraph WS[Web server target group]
          EC2_WS_1["Instance"]
          EC2_WS_2["Instance"]
          EC2_WS_3["Instance"]
      end
  
      subgraph IS[Image server target group]
          EC2_IS_1["Instance"]
          EC2_IS_2["Instance"]
          EC2_IS_3["Instance"]
      end
  
      subgraph LS[Lambda target group]
          EC2_LS["Lambda"]
      end
  end
  ```

### 3. Listener

- ALB 로 들어오는 요청을 처리하는 주체
- 어떤 요청을 받고, 어디로 전송할 지 결정
  - 예시
    ```text
    HTTP 프로토콜, 인바운드 80, 아웃바운드 8081
    HTTP DELETE 요청, 오류 페이지
    ```