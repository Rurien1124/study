## VPC (Virtual Private Cloud)

### 1. 소개

- AWS 계정 전용 가상 네트워크 (가상 데이터센터)
- 부여된 IP 대역을 분할하여 사설망 구축 가능
- 리전 단위로 사용 가능

  ```mermaid
      flowchart TD
      USER[사용자]
      USER -->|일반 서비스는 Public internet 에서<br>바로 접근 가능| N1
      USER ==>|" 1-1. Public internet 직접 접근 "| N2
      N2 ==>|" 1-2. AWS 서비스 접근 "| AS
      N3 ==>|" 2-2. Public internet 접근을 통한<br>AWS service 접근 "| AS
      V1 -.->|일반적으로 접근 불가| AS
  
      subgraph PI[Public internet]
          N1["Node"]
          N2["Node"]
          N3["Node"]
          NS1["Naver"]
          NS2["Google"]
          NS3["GitHub"]
          N1 --> NS1 & NS2 & NS3
      end
  
      subgraph AC[AWS cloud]
          subgraph AS[AWS services]
              S1[("DynamoDB")]
              S2[("S3")]
              S3["CloudWatch"]
          end
  
          subgraph V[VPC]
              V1["EC2"]
              IG("Internet gateway")
              V1 --> IG
              IG ==>|" 2-1. 게이트웨이를 통한<br>Public internet 연결 "| N3
          end
      end
  ```

### 2. 구조

- 서브넷
  - 하나의 서브넷은 하나의 가용 영역에 위치
  - VPC 에 할당된 IP 를 더 작은 단위로 분할
    - IPv4: 최소 /28, 최대 /16 까지 지정 가능
    - IPv6: 최소 /44, 최대 /64 까지 지정 가능
    ```text
    10.0.0.0/28 인 경우 16개(4 비트) - 5개(기본 점유) IP 사용 가능
    - 기본 점유 주소
      10.0.0.0: 네트워크 어드레스
      10.0.0.1: VPC 라우터
      10.0.0.2: DNS 서버
      10.0.0.3: 미래에 사용하기 위해 미사용
      10.0.0.255: 브로드캐스트 주소 (실제 기능은 지원하지 않음)
    ```
  - 종류
    - Public: 인터넷 게이트웨이를 통해 외부에서 연결 가능 (웹, 애플리케이션 서버 등)
    - Private: 외부에서 연결 불가능 (데이터베이스, 로직 서버 등)
    ```mermaid
        flowchart TD
        
        subgraph V["VPC(10.0.0.0/16)"]
    
            E1 <-.-> |직접 통신 불가|E5
            
            subgraph S1["Public subnet"]
                E1["EC2"]
                E2["EC2"]
                E3["EC2"]
                
                E1 <--> E2 & E3
                E2 <--> E3
            end
    
            subgraph S2["Private subnet"]
                E4["EC2"]
                E5["EC2"]
                E6["EC2"]

                E4 <--> E5 & E6
                E5 <--> E6
            end
        end
    ```
- VPC Router
  - 가상의 라우터로 서브넷 간의 네트워크 트래픽을 라우팅
  - 기본 1개가 자동 생성되며, 라우트 테이블만 설정 가능
  - 라우트 테이블에 설정된 항목 중, 가장 유사한 IP로 라우팅
  - 라우트 테이블 예시
    <table>
      <th>Destination</th>
      <th>Target</th>
      <tr>
        <td>10.0.0.0/16</td>
        <td>local</td>
      </tr>
      <tr>
        <td>123.12.0.0/16</td>
        <td>pcx-123456789</td>
      </tr>
      <tr>
        <td>0.0.0.0/0</td>
        <td>igw-123456789</td>
      </tr>
    </table>

    ```mermaid
        flowchart TD
        
        subgraph V["VPC(10.0.0.0/16)"]
            
            subgraph SR1["Router (Public subnet)"]
                RT1[("Route table")]
            end
            subgraph SR2["Router (Private subnet)"]
                RT2[("Route table")]
            end
    
            SR1 <==> |"VPC 라우터를 통한 통신"|SR2
            E1 <==> SR1
            E2 <==> SR2
    
            subgraph S1["Public subnet"]
                E1["EC2"]
            end
    
            subgraph S2["Private subnet"]
                E2["EC2"]
            end
        end
    ```
- 인터넷 게이트웨이
  - 외부에서 VPC 와의 통신 제공
    ```mermaid
        flowchart TD
    
        I["Internet"]
    
        I <==> IG
        
        subgraph V["VPC(10.0.0.0/16)"]
            SR1["Router (Public subnet)"]
            SR2["Router (Private subnet)"]
            
            IG[["Internet gateway"]]
    
            IG <==> SR1
            SR1 <-.-> |인터넷 게이트웨이로는 접근 불가|SR2
            E1 <--> SR1
            E2 <--> SR2
    
            subgraph S1["Public subnet"]
                E1["EC2"]
            end
    
            subgraph S2["Private subnet"]
                E2["EC2"]
            end
        end
    ```
- NAT gateway / NAT instance
  - 프라이빗 서브넷의 인스턴스에서 인터넷 연결을 지원
  - 퍼블릭 서브넷에 위치
  - NAT instance: 단일 EC2 인스턴스, 레거시
  - NAT gateway: 서비스
    ```mermaid
        flowchart TD
    
        I["Internet"]
    
        I <==> IG
        
        subgraph V["VPC(10.0.0.0/16)"]
            SR1["Router (Public subnet)"]
            SR2["Router (Private subnet)"]
            
            IG["Internet gateway"]
    
            IG <==> SR1
            E1 <--> SR1
            NI ==> |1-1. NAT 인스턴스를 통한<br>퍼블릭 서브넷 접근|E2
            NI ==> |1-2. NAT 인스턴스를 통한<br>인터넷 접근|SR1
            
            E2 ==> |2-1. VPC 라우터 접근|SR2
            SR2 ==> |2-2. 퍼블릭 서브넷의<br>VPC 라우터 접근|SR1
            SR1 ==> |2-3. NAT 게이트웨이 접근|NG
            NG ==> |2-4. 인터넷 접근을 위한 VPC 라우터 접근|SR1
    
            subgraph S1["Public subnet"]
                E1["EC2"]
                NI["NAT instance (EC2)"]
                NG{{"NAT gateway"}}
            end
    
            subgraph S2["Private subnet"]
                E2["EC2"]
            end
        end
    ```
- Bastion host (Jump host)
  - 외부에서 프라이빗 서브넷의 리소스 접근을 지원해주는 EC2 인스턴스 (NAT instance 와 반대)
  - 퍼블릭 서브넷에 위치
    ```mermaid
        flowchart TD
    
        I["Internet"]
    
        I <==> |1. 외부에서 인터넷 게이트웨이로 접근|IG
        
        subgraph V["VPC(10.0.0.0/16)"]
            SR1["Router (Public subnet)"]
            SR2["Router (Private subnet)"]
            
            IG["Internet gateway"]
    
            IG <==> |2. 퍼블릭 서브넷 접근을 위한<br>퍼블릭 VPC 라우터 접근|SR1
            SR1 ==> |3. 프라이빗 VPC 라우터 접근을 위한<br>Bastion host 접근|BH
            BH ==> |4. 프라이빗 서브넷 접근을 위한<br>퍼블릭 VPC 라우터 접근|SR1
            SR1 ==> |5. 프라이빗 서브넷의 리소스 접근을 위한<br>프라이빗 VPC 라우터 접근|SR2
            SR2 ==> |6. 리소스 접근|E2
    
            subgraph S1["Public subnet"]
                BH["Bastion host (EC2)"]
            end
    
            subgraph S2["Private subnet"]
                E2["EC2"]
            end
        end
    ```